<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•˜ì´ë”” ì‚¬ì§„ì²© ğŸ¾</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --main-color: #ff6b6b; --bg-color: #fff5f5; }
        body { font-family: 'Nanum Gothic', sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; text-align: center; }
        .header { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 30px; }
        h1 { color: var(--main-color); margin: 0 0 10px 0; }
        #count { color: #888; font-size: 14px; margin-bottom: 20px; }
        .upload-btn { background: var(--main-color); color: white; padding: 15px 30px; border: none; border-radius: 50px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; box-shadow: 0 4px 15px rgba(255,107,107,0.3); }
        .upload-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(255,107,107,0.4); }
        #loading { display: none; color: var(--main-color); font-weight: bold; margin-top: 15px; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; padding: 10px; }
        #photo-grid img { width: 100%; height: 250px; object-fit: cover; border-radius: 15px; cursor: pointer; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        #photo-grid img:hover { transform: scale(1.03); }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ¾ í•˜ì´ë”” ë³´ê´€í•¨</h1>
    <p id="count">ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    <input type="file" id="photo-input" style="display: none;" accept="image/*">
    <button class="upload-btn" onclick="document.getElementById('photo-input').click()">ğŸ“¸ í•˜ì´ë”” ì‚¬ì§„ ì˜¬ë¦¬ê¸°</button>
    <div id="loading">í•˜ì´ë”” ì‚¬ì§„ ì „ì†¡ ì¤‘... ğŸš€ (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!)</div>
</div>

<div id="photo-grid"></div>

<script>
    // [1] Firebase ì„¤ì • : ë°©ê¸ˆ ì°¾ìœ¼ì‹  ìµœì‹ ê°’ìœ¼ë¡œ ë„£ì–´ë‘ì—ˆìŠµë‹ˆë‹¤!
    const firebaseConfig = {
        apiKey: "AIzaSyCJNwDkyHDZKOXGS-su1824U6AetbhgISE",
        authDomain: "ji-hyun.firebaseapp.com",
        projectId: "ji-hyun",
        storageBucket: "ji-hyun.firebasestorage.app",
        messagingSenderId: "632016266007",
        appId: "1:632016266007:web:37d61d9221f43d0fe14d52"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // [2] ImgBB ì„¤ì • : ì¹´ë“œ ë“±ë¡ ì—†ì´ ì“¸ ìˆ˜ ìˆëŠ” ì‚¬ì§„ ì €ì¥ì†Œ í‚¤ì…ë‹ˆë‹¤.
    const IMGBB_API_KEY = "2744736d28ebf00992c6bdefe9519c13";

    // ë¡œê·¸ì¸ ë° ë°ì´í„° ë¡œë“œ (ì‹¤ì‹œê°„ ì—°ë™)
    auth.onAuthStateChanged(user => {
        if (user) {
            loadPhotos(user.uid);
        } else {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(() => location.reload());
        }
    });

    // ì—…ë¡œë“œ ë¡œì§ (ImgBBì— ì €ì¥í•˜ê³  ì£¼ì†Œë§Œ Firestoreì— ê¸°ë¡)
    document.getElementById('photo-input').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('loading').style.display = 'block';

        try {
            // A. ImgBB ì„œë²„ë¡œ ì‚¬ì§„ ì „ì†¡
            const formData = new FormData();
            formData.append("image", file);

            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: "POST",
                body: formData
            });
            const result = await res.json();
            
            if (result.success) {
                const imageUrl = result.data.url;

                // B. Firestoreì— ì´ë¯¸ì§€ ì£¼ì†Œ ì €ì¥
                await db.collection("photos").add({
                    url: imageUrl,
                    uid: auth.currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert("í•˜ì´ë”” ì‚¬ì§„ ì—…ë¡œë“œ ì„±ê³µ! âœ¨");
            }
        } catch (err) {
            console.error("ì—…ë¡œë“œ ì‹¤íŒ¨:", err);
            alert("ì‚¬ì§„ ì „ì†¡ì— ì‹¤íŒ¨í–ˆì–´ìš” ã… ã…  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    };

    // ì‹¤ì‹œê°„ ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸° ë° ê·¸ë¦¬ë“œ ìƒì„±
    function loadPhotos(uid) {
        db.collection("photos")
            .where("uid", "==", uid)
            .orderBy("createdAt", "desc")
            .onSnapshot(snap => {
                const grid = document.getElementById('photo-grid');
                grid.innerHTML = '';
                document.getElementById('count').innerText = `ì´ ${snap.size}ì¥ì˜ í•˜ì´ë”” ì‚¬ì§„ì´ ë³´ê´€ë˜ì–´ ìˆìŠµë‹ˆë‹¤!`;
                
                snap.forEach(doc => {
                    const img = document.createElement('img');
                    img.src = doc.data().url;
                    // í´ë¦­í•˜ë©´ ì›ë³¸ ì‚¬ì§„ ìƒˆì°½ìœ¼ë¡œ ë³´ê¸°
                    img.onclick = () => window.open(img.src, '_blank');
                    grid.appendChild(img);
                });
            }, err => {
                console.error("ë°ì´í„° ë¡œë“œ ì—ëŸ¬:", err);
                if(err.message.includes('index')) {
                    document.getElementById('count').innerText = "ìƒ‰ì¸ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... ì•½ 1~2ë¶„ ë’¤ ì‚¬ì§„ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.";
                }
            });
    }
</script>
</body>
</html>
