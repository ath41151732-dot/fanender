<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•˜ì´ë”” ì‚¬ì§„ì²© ğŸ¾</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --main-color: #ff6b6b; --bg-color: #fff5f5; }
        body { font-family: 'Nanum Gothic', sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; text-align: center; }
        .header { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 30px; }
        h1 { color: var(--main-color); margin: 0 0 10px 0; }
        #count { color: #888; font-size: 14px; margin-bottom: 20px; }
        .upload-btn { background: var(--main-color); color: white; padding: 15px 30px; border: none; border-radius: 50px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; box-shadow: 0 4px 15px rgba(255,107,107,0.3); }
        #photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 10px; }
        #photo-grid img { width: 100%; height: 150px; object-fit: cover; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        
        /* ëª¨ë‹¬(í¬ê²Œ ë³´ê¸°) ìŠ¤íƒ€ì¼ */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        #modal img { max-width: 90%; max-height: 70%; border-radius: 10px; margin-bottom: 20px; }
        .modal-btns { display: flex; gap: 20px; }
        .btn { padding: 12px 25px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; }
        .save-btn { background: #4dabf7; color: white; }
        .del-btn { background: #ff6b6b; color: white; }
        .close-btn { background: white; color: black; }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ¾ í•˜ì´ë”” ë³´ê´€í•¨</h1>
    <p id="count">ì‚¬ì§„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    <input type="file" id="photo-input" style="display: none;" accept="image/*">
    <button class="upload-btn" onclick="document.getElementById('photo-input').click()">ğŸ“¸ ì‚¬ì§„ ì˜¬ë¦¬ê¸°</button>
</div>

<div id="photo-grid"></div>

<div id="modal">
    <img id="modal-img" src="">
    <div class="modal-btns">
        <button class="btn save-btn" id="download-link">ë‚´ í°ì— ì €ì¥</button>
        <button class="btn del-btn" id="delete-btn">ì‚­ì œí•˜ê¸°</button>
        <button class="btn close-btn" onclick="closeModal()">ë‹«ê¸°</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCJNwDkyHDZKOXGS-su1824U6AetbhgISE",
        authDomain: "ji-hyun.firebaseapp.com",
        projectId: "ji-hyun",
        storageBucket: "ji-hyun.firebasestorage.app",
        messagingSenderId: "632016266007",
        appId: "1:632016266007:web:37d61d9221f43d0fe14d52"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const IMGBB_API_KEY = "2744736d28ebf00992c6bdefe9519c13";

    let currentDocId = ""; // í˜„ì¬ ì„ íƒëœ ì‚¬ì§„ì˜ ID

    auth.onAuthStateChanged(user => {
        if (user) { loadPhotos(user.uid); } 
        else { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).then(() => location.reload()); }
    });

    document.getElementById('photo-input').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
            const formData = new FormData();
            formData.append("image", file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
            const result = await res.json();
            if (result.success) {
                await db.collection("photos").add({
                    url: result.data.url,
                    uid: auth.currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        } catch (err) { alert("ì‹¤íŒ¨!"); }
    };

    function loadPhotos(uid) {
        db.collection("photos").where("uid", "==", uid).orderBy("createdAt", "desc").onSnapshot(snap => {
            const grid = document.getElementById('photo-grid');
            grid.innerHTML = '';
            document.getElementById('count').innerText = `ì´ ${snap.size}ì¥ì˜ ì‚¬ì§„ì´ ìˆìŠµë‹ˆë‹¤.`;
            snap.forEach(doc => {
                const img = document.createElement('img');
                img.src = doc.data().url;
                img.onclick = () => openModal(doc.id, doc.data().url);
                grid.appendChild(img);
            });
        });
    }

    // ëª¨ë‹¬ ì—´ê¸° (ì‚­ì œ/ì €ì¥ ê¸°ëŠ¥ ì—°ê²°)
    function openModal(id, url) {
        currentDocId = id;
        document.getElementById('modal-img').src = url;
        document.getElementById('modal').style.display = 'flex';
        
        // ì €ì¥ ê¸°ëŠ¥ (ìƒˆ ì°½ìœ¼ë¡œ ì—´ì–´ì„œ ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥ ìœ ë„)
        document.getElementById('download-link').onclick = () => {
            window.open(url, '_blank');
        };

        // ì‚­ì œ ê¸°ëŠ¥
        document.getElementById('delete-btn').onclick = async () => {
            if(confirm("ì •ë§ ì´ ì‚¬ì§„ì„ ì‚­ì œí• ê¹Œìš”?")) {
                await db.collection("photos").doc(currentDocId).delete();
                closeModal();
            }
        };
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }
</script>
</body>
</html>
