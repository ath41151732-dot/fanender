<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•˜ì´ë”” í´ë¼ìš°ë“œ ì‚¬ì§„ì²©</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --p: #ff4d6d; --bg: #fff5f7; }
        body { margin: 0; background: var(--bg); font-family: sans-serif; padding-bottom: 50px; }
        .nav { position: sticky; top: 0; background: white; display: flex; align-items: center; padding: 15px 20px; z-index: 100; border-bottom: 1px solid #ffe0e5; }
        .back-btn { text-decoration: none; color: var(--p); font-weight: bold; }
        h1 { font-size: 1.1rem; flex-grow: 1; text-align: center; margin: 0; margin-right: 40px; }
        .upload-section { padding: 20px; text-align: center; }
        .upload-btn { background: var(--p); color: white; padding: 12px 25px; border-radius: 25px; cursor: pointer; display: inline-block; font-weight: bold; box-shadow: 0 4px 10px rgba(255, 77, 109, 0.3); }
        #file-input { display: none; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; padding: 3px; }
        .grid img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; cursor: pointer; background: #eee; }
        #modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        #modal img { max-width: 95%; max-height: 85%; }
    </style>
</head>
<body>

    <div class="nav">
        <a href="index.html" class="back-btn">â—€ ë©”ì¸</a>
        <h1 id="count">ì‚¬ì§„ì²© ë¡œë”© ì¤‘...</h1>
    </div>

    <div class="upload-section">
        <label for="file-input" class="upload-btn">ğŸ“¸ í•˜ì´ë”” ì‚¬ì§„ ì˜¬ë¦¬ê¸°</label>
        <input type="file" id="file-input" accept="image/*" onchange="uploadPhoto(this)">
    </div>

    <div class="grid" id="photo-grid"></div>

    <div id="modal" onclick="this.style.display='none'"><img id="modal-img" src=""></div>

    <script>
        // ë³´ë‚´ì£¼ì‹  ì„¤ì •ê°’ì„ ê·¸ëŒ€ë¡œ ì ìš©í–ˆìŠµë‹ˆë‹¤!
        const firebaseConfig = {
            apiKey: "AIzaSyCJNwDkyHDZKOXGS-su1824U6AetbhgISE",
            authDomain: "ji-hyun.firebaseapp.com",
            projectId: "ji-hyun",
            storageBucket: "ji-hyun.firebasestorage.app",
            messagingSenderId: "632016266007",
            appId: "1:632016266007:web:37d61d9221f43d0fe14d52"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const storage = firebase.storage();
        const db = firebase.firestore();

        // 1. ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸°
        auth.onAuthStateChanged(user => {
            if (user) {
                loadPhotos(user.uid);
            } else {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider);
            }
        });

        // 2. ì‚¬ì§„ ì—…ë¡œë“œ í•¨ìˆ˜
        async function uploadPhoto(input) {
            const file = input.files[0];
            const user = auth.currentUser;
            if (!file || !user) return;

            document.getElementById('count').innerText = "ì—…ë¡œë“œ ì¤‘...ğŸš€";
            
            try {
                // Storage ì°½ê³ ì— ì €ì¥
                const ref = storage.ref(`photos/${user.uid}/${Date.now()}_${file.name}`);
                await ref.put(file);
                const url = await ref.getDownloadURL();

                // Firestore ì¥ë¶€ì— ê¸°ë¡
                await db.collection("photos").add({
                    uid: user.uid,
                    url: url,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) {
                alert("Storageê°€ ì•„ì§ ì•ˆ ì—´ë ¤ìˆê±°ë‚˜ ê·œì¹™ ì„¤ì •ì´ ì•ˆ ë˜ì—ˆë„¤ìš”! ê·œì¹™ íƒ­ì—ì„œ allow read, write: if true;ë¡œ ë°”ê¿”ì£¼ì„¸ìš”.");
                console.error(e);
            }
        }

        // 3. ì‚¬ì§„ ë¦¬ìŠ¤íŠ¸ ì‹¤ì‹œê°„ ë¡œë“œ
        function loadPhotos(uid) {
            db.collection("photos")
              .where("uid", "==", uid)
              .orderBy("createdAt", "desc")
              .onSnapshot(snap => {
                  const grid = document.getElementById('photo-grid');
                  grid.innerHTML = '';
                  document.getElementById('count').innerText = `ëª¨ë“  ì‚¬ì§„ (${snap.size})`;
                  snap.forEach(doc => {
                      const img = document.createElement('img');
                      img.src = doc.data().url;
                      img.onclick = () => {
                          document.getElementById('modal-img').src = img.src;
                          document.getElementById('modal').style.display = 'flex';
                      };
                      grid.appendChild(img);
                  });
              });
        }
    </script>
</body>
</html>